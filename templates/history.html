<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analysis History - BakuDocs Smart Document Analysis System</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body>
<div class="app-container">
  <div class="main-card">
    <!-- 頁首 -->
    <div class="app-header">
      <div class="logo">
        <img src="{{ url_for('static', filename='panda_logo.png') }}" alt="BakuDocs Logo" class="logo-image">
      </div>
      <h1>Analysis History</h1>
      <p class="subtitle">View History</p>
    </div>

    <!-- 用戶訊息欄 -->
    <div class="user-info-bar">
      <div class="user-welcome">
        <i class="fas fa-user-circle"></i>
        Welcome, <strong>{{ session.username }}</strong>
      </div>
      <div class="user-actions">
        <!-- Language selector removed -->
        
        {% if session.is_admin %}
        <a href="/admin" class="btn btn-secondary btn-sm">
          <i class="fas fa-cogs"></i>
          Admin Dashboard
        </a>
        {% endif %}
        <a href="/" class="btn btn-outline btn-sm">
          <i class="fas fa-home"></i>
          Back
        </a>
        <a href="/logout" class="btn btn-danger btn-sm">
          <i class="fas fa-sign-out-alt"></i>
          Logout
        </a>
      </div>
    </div>

    <!-- 主要內容 -->
    <div class="main-content">
      {% if history and history|length > 0 %}
      <!-- 統計摘要 -->
      <div class="admin-stats">
        <div class="stat-card">
          <span class="stat-number">{{ history|length }}</span>
          <div class="stat-label">Total Analyses</div>
        </div>
        <div class="stat-card">
          <span class="stat-number">{{ history|map(attribute='tokens')|sum or 0 }}</span>
          <div class="stat-label">Total Token Usage</div>
        </div>
        <div class="stat-card">
          <span class="stat-number">{{ history|map(attribute='rows')|sum or 0 }}</span>
          <div class="stat-label">Total Analysis Rows</div>
        </div>
        <div class="stat-card">
          <span class="stat-number">{{ (history|map(attribute='files')|map('length')|sum) or 0 }}</span>
          <div class="stat-label">Total Processed Files</div>
        </div>
      </div>

      <!-- 歷史記錄表格 -->
      <div class="card">
        <div class="card-header">
          <i class="fas fa-chart-line"></i>
          Analysis Record Details
        </div>
        <div class="card-body" style="padding: 0;">
          <div style="overflow-x: auto;">
            <table class="data-table" style="margin: 0;">
              <thead>
                <tr>
                  <th>Time</th>
                  <th>Analyzer Used</th>
                  <th>Files Analyzed</th>
                  <th>Analysis Result</th>
                  <th>Performance</th>
                  <th>Operations</th>
                </tr>
              </thead>
              <tbody>
                {% for h in history %}
                <tr data-files='{{ h.get("files", [])|tojson }}' data-total-pages='{{ h.get("total_pages", 0) }}'>
                  <td>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <i class="fas fa-clock" style="color: var(--text-secondary);"></i>
                      <div>
                        {% set time_str = h.get('time', h.get('timestamp', '')) %}
                        {% if time_str and ' ' in time_str %}
                          {% set date_part, time_part = time_str.split(' ', 1) %}
                          <div style="font-weight: 500;">{{ date_part }}</div>
                          {% if ':' in time_part %}
                            {% set time_parts = time_part.split(':') %}
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">
                              {{ time_parts[0] }}:{{ time_parts[1] }}
                            </div>
                          {% else %}
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">
                              {{ time_part }}
                            </div>
                          {% endif %}
                        {% else %}
                          <div style="font-weight: 500;">{{ time_str }}</div>
                        {% endif %}
                      </div>
                    </div>
                  </td>
                  <td>
                    <span style="background: var(--primary-color); color: white; padding: 0.25rem 0.75rem; 
                                 border-radius: var(--radius-sm); font-size: 0.875rem; font-weight: 600;">
                      {{ h.get('analysis_type', 'Unknown') }}
                    </span>
                  </td>
                  <td>
                    {% if h.get('files') %}
                      <div style="max-width: 250px;">
                        {% for file in h.get('files')[:2] %}
                          <div style="display: flex; align-items: center; gap: 0.25rem; margin-bottom: 0.25rem;">
                            <i class="fas fa-file" style="color: var(--primary-color); font-size: 0.75rem;"></i>
                            <span style="font-size: 0.875rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                              {{ file }}
                            </span>
                          </div>
                        {% endfor %}
                        {% if h.get('files')|length > 2 %}
                          <div style="color: var(--primary-color); font-size: 0.75rem; cursor: pointer;" onclick="showAllFiles({{ loop.index0 }})" title="Click to view all files">
                            <i class="fas fa-eye"></i>
                            +{{ h.get('files')|length - 2 }} files
                          </div>
                        {% endif %}
                        {% if h.get('total_pages', 0) > 0 %}
                          <div style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 0.25rem;">
                            <i class="fas fa-file-alt"></i> {{ h.get('total_pages', 0) }} pages
                          </div>
                        {% endif %}
                      </div>
                    {% else %}
                      <span style="color: var(--text-secondary);">No file information</span>
                    {% endif %}
                  </td>
                  <td>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <i class="fas fa-table" style="color: var(--success-color);"></i>
                      <span style="font-weight: 500;">{{ h.get('rows', 0) }} × {{ h.get('cols', 0) }}</span>
                    </div>
                  </td>
                  <td>
                    <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                      <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-coins" style="color: var(--warning-color);"></i>
                        <span style="font-weight: 500;">{{ h.get('tokens', 0) }}</span>
                      </div>
                      {% if h.get('duration_str') %}
                      <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; color: var(--text-secondary);">
                        <i class="fas fa-stopwatch"></i>
                        {{ h.get('duration_str') }}
                      </div>
                      {% endif %}
                    </div>
                  </td>
                  <td>
                    {% if h.get('excel') %}
                      <a href="/export/{{ h['excel'] }}" class="btn btn-sm btn-success">
                        <i class="fas fa-download"></i>
                        Excel
                      </a>
                    {% else %}
                      <span style="color: var(--text-secondary); font-size: 0.875rem;">
                        <i class="fas fa-times-circle"></i>
                        No file
                      </span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      {% else %}
      <!-- 空狀態 -->
      <div style="text-align: center; padding: 4rem 2rem;">
        <div style="font-size: 4rem; color: var(--text-secondary); margin-bottom: 1.5rem;">
          <i class="fas fa-file-search"></i>
        </div>
        <h2 style="color: var(--text-primary); margin-bottom: 1rem;">No Analysis Records</h2>
        <p style="color: var(--text-secondary); margin-bottom: 2rem;">
          You haven't performed any document analysis yet. Start analyzing your documents now!
        </p>
        <a href="/" class="btn btn-primary btn-lg">
          <i class="fas fa-plus"></i>
          Start Analysis
        </a>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
// 頁面載入動畫
document.addEventListener('DOMContentLoaded', function() {
  const rows = document.querySelectorAll('.data-table tbody tr');
  
  rows.forEach((row, index) => {
    row.style.opacity = '0';
    row.style.transform = 'translateY(20px)';
    
    setTimeout(() => {
      row.style.transition = 'all 0.3s ease';
      row.style.opacity = '1';
      row.style.transform = 'translateY(0)';
    }, index * 100);
  });
});

// 統計數字動畫
function animateNumbers() {
  const numbers = document.querySelectorAll('.stat-number');
  
  numbers.forEach(numberEl => {
    const finalNumber = parseInt(numberEl.textContent) || 0;
    const duration = 1000;
    const steps = 20;
    const increment = finalNumber / steps;
    let current = 0;
    
    const timer = setInterval(() => {
      current += increment;
      if (current >= finalNumber) {
        numberEl.textContent = finalNumber;
        clearInterval(timer);
      } else {
        numberEl.textContent = Math.floor(current);
      }
    }, duration / steps);
  });
}

// 如果有統計資料，執行動畫
if (document.querySelector('.admin-stats')) {
  setTimeout(animateNumbers, 500);
}

// 顯示所有檔案的模態框
function showAllFiles(index) {
  const rows = document.querySelectorAll('tbody tr');
  const targetRow = rows[index];
  
  if (!targetRow) {
    alert('Unable to find corresponding record');
    return;
  }
  
  // 從 data 屬性獲取檔案列表
  let files = [];
  const filesData = targetRow.dataset.files;
  
  if (filesData && filesData.trim() !== '') {
    try {
      if (filesData.startsWith('[') && filesData.endsWith(']')) {
        files = JSON.parse(filesData);
      } else {
        console.error('Invalid JSON format:', filesData);
        alert('Invalid file data format');
        return;
      }
    } catch (e) {
      console.error('Failed to parse file data:', e);
      alert('Failed to parse file data: ' + e.message);
      return;
    }
  } else {
    alert('Unable to get file list data');
    return;
  }
  
  if (!files || files.length === 0) {
    alert('This record has no associated files');
    return;
  }
  
  // 生成檔案列表HTML，與admin頁面保持一致的樣式
  const fileList = files.map((file, index) => `
    <div style="padding: 0.75rem; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between;">
      <div style="display: flex; align-items: center; flex: 1;">
        <span style="background: var(--primary-color); color: white; padding: 0.25rem 0.5rem; border-radius: var(--radius-sm); font-size: 0.75rem; font-weight: 600; margin-right: 0.75rem; min-width: 30px; text-align: center;">#${index + 1}</span>
        <i class="fas fa-file" style="margin-right: 0.5rem; color: var(--primary-color);"></i>
        <span style="font-size: 0.875rem;">${file}</span>
      </div>
    </div>
  `).join('');
  
  // Get page count from the row data
  const totalPages = targetRow.querySelector('[data-total-pages]')?.dataset.totalPages || 0;
  
  // Update modal content with file count and page count
  const modalContent = `
    <div style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: var(--radius-md);">
      ${fileList}
    </div>
    <div style="margin-top: 1rem; color: var(--text-secondary); font-size: 0.875rem; text-align: center;">
      <i class="fas fa-info-circle"></i> Total ${files.length} files${totalPages > 0 ? ` | <i class="fas fa-file-alt"></i> ${totalPages} pages` : ''}
    </div>
  `;
  
  document.getElementById('fileListContent').innerHTML = modalContent;
  document.getElementById('fileListModal').style.display = 'flex';
}

// 關閉檔案列表模態框
function closeFileListModal() {
  document.getElementById('fileListModal').style.display = 'none';
}

// 語言切換功能
function toggleLanguageMenu() {
  const menu = document.getElementById('languageMenu');
  menu.classList.toggle('show');
}

// 點擊其他地方關閉語言選單
document.addEventListener('click', function(event) {
  const selector = document.querySelector('.language-selector');
  const menu = document.getElementById('languageMenu');
  
  if (selector && menu && !selector.contains(event.target)) {
    menu.classList.remove('show');
  }
});

// 點擊模態框外部關閉
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('fileListModal');
  if (modal) {
    modal.addEventListener('click', function(e) {
      if (e.target === this) {
        closeFileListModal();
      }
    });
  }
});
</script>

<!-- 檔案列表模態框 -->
<div id="fileListModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; justify-content: center; align-items: center;">
  <div style="background: white; border-radius: 0.75rem; max-width: 600px; width: 90%; max-height: 70vh; overflow-y: auto; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);">
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1.5rem; border-bottom: 1px solid #e2e8f0; background: #f8fafc; border-radius: 0.75rem 0.75rem 0 0;">
      <h3 style="margin: 0; color: #1e293b; font-size: 1.25rem; font-weight: 600;">
        <i class="fas fa-folder-open" style="margin-right: 0.5rem; color: var(--primary-color);"></i>
        File List
      </h3>
      <span onclick="closeFileListModal()" style="font-size: 1.5rem; color: #64748b; cursor: pointer; padding: 0.25rem; line-height: 1;" title="Close">
        <i class="fas fa-times"></i>
      </span>
    </div>
    <div style="padding: 1.5rem;">
      <div id="fileListContent">
        <!-- 檔案列表將在這裡顯示 -->
      </div>
    </div>
  </div>
</div>

</body>
</html>